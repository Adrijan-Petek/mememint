export const shareToImgbb = async (permanentMemeUrl: string | null) => {
  if (!permanentMemeUrl) return;

  try {
    const shareText = `Just minted a meme on MemeMint! ðŸŽ¨âœ¨`;

    // Use official Farcaster SDK to detect MiniApp context
    let inMiniApp = false;
    try {
      const { isInMiniApp } = await import('@farcaster/miniapp-sdk');
      inMiniApp = await isInMiniApp();
      console.log('ðŸ” MiniApp Detection (SDK):', inMiniApp);
    } catch {
      console.log('âš ï¸ MiniApp SDK not available, assuming web browser');
    }

    // If in Farcaster MiniApp, use native composer action
    if (inMiniApp) {
      console.log('ðŸŽ­ Opening native Farcaster composer...');
      try {
        const { sdk } = await import('@farcaster/miniapp-sdk');
        const result = await sdk.actions.composeCast({
          text: shareText,
          embeds: [permanentMemeUrl]
        });
        console.log('âœ… Compose result:', result);
        if (result?.cast) {
          alert('Cast created successfully! ðŸŽ‰');
        }
        return;
      } catch (composerError) {
        console.error('âŒ Native composer failed:', composerError);
        // Fall through to clipboard fallback
      }
    }

    // Regular web app fallback - copy to clipboard
    console.log('ï¿½ Web browser - copying to clipboard');
    const fullText = `${shareText}\n\n${permanentMemeUrl}`;
    await navigator.clipboard.writeText(fullText);
    alert('Meme link copied to clipboard! Share it on Farcaster.');
  } catch (error) {
    console.error('Error sharing meme:', error);
    alert('Failed to share meme. Please try again.');
  }
};

export const downloadMeme = async (generatedMeme: string | null) => {
  if (!generatedMeme) return;

  try {
    // Use official Farcaster SDK to detect MiniApp context
    let inMiniApp = false;
    try {
      const { isInMiniApp } = await import('@farcaster/miniapp-sdk');
      inMiniApp = await isInMiniApp();
      console.log('ðŸ” MiniApp Detection (Download):', inMiniApp);
    } catch {
      console.log('âš ï¸ MiniApp SDK not available for download, assuming web browser');
    }

    // If in MiniApp, open image in new tab (mobile devices can then save)
    if (inMiniApp) {
      console.log('ðŸ“± MiniApp - Opening image in new tab...');
      const opened = window.open(generatedMeme, '_blank');
      if (!opened) {
        window.location.href = generatedMeme;
      }
      alert('Image opened! You can now save it from your browser.');
      return;
    }

    // Regular web app - direct download
    const response = await fetch(generatedMeme);
    const blob = await response.blob();
    
    // Determine file extension based on MIME type
    let extension = 'png';
    if (blob.type === 'image/jpeg') {
      extension = 'jpg';
    }
    
    console.log('ðŸ’¾ Downloading meme as:', extension, 'type:', blob.type);
    
    // Create blob URL for download
    const blobUrl = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = blobUrl;
    a.download = `mememint-${Date.now()}.${extension}`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    // Clean up blob URL
    setTimeout(() => URL.revokeObjectURL(blobUrl), 100);
  } catch (error) {
    console.error('Error downloading meme:', error);
    // Fallback to simple download
    const a = document.createElement('a');
    a.href = generatedMeme;
    a.download = `mememint-${Date.now()}.png`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
};